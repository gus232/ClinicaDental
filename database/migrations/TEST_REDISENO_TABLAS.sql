-- ============================================================================
-- SCRIPT DE TESTING: VERIFICACI√ìN DEL REDISE√ëO DE TABLAS
-- ============================================================================
-- Descripci√≥n: Verifica que el redise√±o de doctors, patients y admins
--              funcione correctamente con datos de prueba
-- Fecha: 2025-10-28
-- Proyecto: SIS 321 - Sistema Hospital Muelitas
--
-- ‚ö†Ô∏è  IMPORTANTE: Este script es para TESTING
-- ‚ö†Ô∏è  Ejecuta DESPU√âS de aplicar las migraciones
-- ‚ö†Ô∏è  NO ejecutar en producci√≥n con datos reales
--
-- ============================================================================

USE hms_v2;

SELECT '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó' AS '';
SELECT '‚ïë          SCRIPT DE TESTING - REDISE√ëO DE TABLAS               ‚ïë' AS '';
SELECT '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù' AS '';
SELECT '' AS '';

-- ============================================================================
-- 1. VERIFICAR ESTRUCTURA DE TABLAS
-- ============================================================================

SELECT 'üìã PASO 1: Verificando estructura de tablas...' AS status;
SELECT '' AS '';

-- Verificar que las tablas existen
SELECT
    CASE
        WHEN COUNT(*) = 3 THEN '‚úì Todas las tablas redise√±adas existen'
        ELSE CONCAT('‚ùå ERROR: Faltan tablas. Encontradas: ', COUNT(*))
    END AS structure_check
FROM information_schema.tables
WHERE table_schema = 'hms_v2'
  AND table_name IN ('doctors', 'patients', 'admins');

-- Verificar campos espec√≠ficos de doctors
SELECT '‚úì Campos de doctors:' AS '';
SELECT
    CASE
        WHEN COUNT(*) >= 10 THEN CONCAT('  ‚úì doctors tiene ', COUNT(*), ' campos (esperado: >=10)')
        ELSE CONCAT('  ‚ùå doctors tiene solo ', COUNT(*), ' campos')
    END AS doctors_fields
FROM information_schema.columns
WHERE table_schema = 'hms_v2'
  AND table_name = 'doctors';

-- Verificar campos espec√≠ficos de patients
SELECT
    CASE
        WHEN COUNT(*) >= 15 THEN CONCAT('  ‚úì patients tiene ', COUNT(*), ' campos (esperado: >=15)')
        ELSE CONCAT('  ‚ùå patients tiene solo ', COUNT(*), ' campos')
    END AS patients_fields
FROM information_schema.columns
WHERE table_schema = 'hms_v2'
  AND table_name = 'patients';

-- Verificar campos espec√≠ficos de admins
SELECT
    CASE
        WHEN COUNT(*) >= 20 THEN CONCAT('  ‚úì admins tiene ', COUNT(*), ' campos (esperado: >=20)')
        ELSE CONCAT('  ‚ùå admins tiene solo ', COUNT(*), ' campos')
    END AS admins_fields
FROM information_schema.columns
WHERE table_schema = 'hms_v2'
  AND table_name = 'admins';

-- ============================================================================
-- 2. CREAR USUARIOS DE PRUEBA
-- ============================================================================

SELECT '' AS '';
SELECT 'üß™ PASO 2: Creando usuarios de prueba...' AS status;

-- Limpiar usuarios de prueba anteriores si existen
DELETE FROM users WHERE email LIKE 'test_%@test.com';

SELECT '  ‚úì Usuarios de prueba anteriores eliminados' AS '';

-- Crear usuario de prueba tipo DOCTOR
INSERT INTO users (email, password, user_type, full_name, status)
VALUES (
    'test_doctor@test.com',
    '$2y$10$abcdefghijklmnopqrstuv',  -- Hash de prueba
    'doctor',
    'Dr. Juan P√©rez Test',
    'active'
);

SET @test_doctor_id = LAST_INSERT_ID();
SELECT CONCAT('  ‚úì Usuario doctor creado con ID: ', @test_doctor_id) AS '';

-- Crear registro en tabla doctors
INSERT INTO doctors (
    user_id,
    specialization_id,
    license_number,
    consultation_fee,
    years_of_experience,
    status
) VALUES (
    @test_doctor_id,
    1,  -- Asume que existe especializaci√≥n con ID 1
    'LIC-TEST-001',
    150.00,
    5,
    'active'
);

SELECT '  ‚úì Registro de doctor creado en tabla doctors' AS '';

-- Crear usuario de prueba tipo PATIENT
INSERT INTO users (email, password, user_type, full_name, status)
VALUES (
    'test_patient@test.com',
    '$2y$10$abcdefghijklmnopqrstuv',
    'patient',
    'Mar√≠a Garc√≠a Test',
    'active'
);

SET @test_patient_id = LAST_INSERT_ID();
SELECT CONCAT('  ‚úì Usuario patient creado con ID: ', @test_patient_id) AS '';

-- Crear registro en tabla patients
INSERT INTO patients (
    user_id,
    address,
    city,
    gender,
    date_of_birth,
    blood_type,
    status
) VALUES (
    @test_patient_id,
    'Calle Test 123',
    'La Paz',
    'female',
    '1990-05-15',
    'O+',
    'active'
);

SELECT '  ‚úì Registro de patient creado en tabla patients' AS '';

-- Crear usuario de prueba tipo ADMIN
INSERT INTO users (email, password, user_type, full_name, status)
VALUES (
    'test_admin@test.com',
    '$2y$10$abcdefghijklmnopqrstuv',
    'admin',
    'Carlos Admin Test',
    'active'
);

SET @test_admin_id = LAST_INSERT_ID();
SELECT CONCAT('  ‚úì Usuario admin creado con ID: ', @test_admin_id) AS '';

-- Crear registro en tabla admins
INSERT INTO admins (
    user_id,
    employee_id,
    department,
    admin_level,
    technical_area,
    certifications,
    status
) VALUES (
    @test_admin_id,
    CONCAT('EMP', LPAD(@test_admin_id, 5, '0')),
    'security',
    'security',
    'Seguridad de Sistemas',
    'CISSP, CEH',
    'active'
);

SELECT '  ‚úì Registro de admin creado en tabla admins' AS '';

-- ============================================================================
-- 3. VERIFICAR INTEGRIDAD REFERENCIAL
-- ============================================================================

SELECT '' AS '';
SELECT 'üîó PASO 3: Verificando integridad referencial...' AS status;

-- Verificar que el doctor tiene relaci√≥n v√°lida con users
SELECT
    CASE
        WHEN COUNT(*) = 1 THEN '  ‚úì Doctor: Relaci√≥n users ‚Üî doctors OK'
        ELSE '  ‚ùå Doctor: Problema en relaci√≥n'
    END AS doctor_integrity
FROM doctors d
INNER JOIN users u ON d.user_id = u.id
WHERE u.id = @test_doctor_id;

-- Verificar que el patient tiene relaci√≥n v√°lida con users
SELECT
    CASE
        WHEN COUNT(*) = 1 THEN '  ‚úì Patient: Relaci√≥n users ‚Üî patients OK'
        ELSE '  ‚ùå Patient: Problema en relaci√≥n'
    END AS patient_integrity
FROM patients p
INNER JOIN users u ON p.user_id = u.id
WHERE u.id = @test_patient_id;

-- Verificar que el admin tiene relaci√≥n v√°lida con users
SELECT
    CASE
        WHEN COUNT(*) = 1 THEN '  ‚úì Admin: Relaci√≥n users ‚Üî admins OK'
        ELSE '  ‚ùå Admin: Problema en relaci√≥n'
    END AS admin_integrity
FROM admins a
INNER JOIN users u ON a.user_id = u.id
WHERE u.id = @test_admin_id;

-- ============================================================================
-- 4. VERIFICAR CAMPOS ESPEC√çFICOS
-- ============================================================================

SELECT '' AS '';
SELECT '‚úÖ PASO 4: Verificando campos espec√≠ficos...' AS status;

-- Verificar campos de doctors
SELECT
    u.full_name,
    d.license_number,
    d.consultation_fee,
    d.years_of_experience,
    d.status
FROM doctors d
INNER JOIN users u ON d.user_id = u.id
WHERE u.id = @test_doctor_id;

SELECT '  ‚úì Campos de doctor verificados' AS '';

-- Verificar campos de patients
SELECT
    u.full_name,
    p.address,
    p.city,
    p.gender,
    p.blood_type,
    p.status
FROM patients p
INNER JOIN users u ON p.user_id = u.id
WHERE u.id = @test_patient_id;

SELECT '  ‚úì Campos de patient verificados' AS '';

-- Verificar campos de admins
SELECT
    u.full_name,
    a.employee_id,
    a.department,
    a.admin_level,
    a.technical_area,
    a.certifications,
    a.status
FROM admins a
INNER JOIN users u ON a.user_id = u.id
WHERE u.id = @test_admin_id;

SELECT '  ‚úì Campos de admin verificados' AS '';

-- ============================================================================
-- 5. PROBAR CASCADE DELETE
-- ============================================================================

SELECT '' AS '';
SELECT 'üóëÔ∏è  PASO 5: Probando CASCADE DELETE...' AS status;

-- Eliminar usuario doctor (debe eliminar registro de doctors autom√°ticamente)
DELETE FROM users WHERE id = @test_doctor_id;

SELECT
    CASE
        WHEN COUNT(*) = 0 THEN '  ‚úì CASCADE DELETE: doctors eliminado autom√°ticamente'
        ELSE '  ‚ùå CASCADE DELETE: registro de doctors no se elimin√≥'
    END AS cascade_test_doctor
FROM doctors WHERE user_id = @test_doctor_id;

-- Eliminar usuario patient
DELETE FROM users WHERE id = @test_patient_id;

SELECT
    CASE
        WHEN COUNT(*) = 0 THEN '  ‚úì CASCADE DELETE: patients eliminado autom√°ticamente'
        ELSE '  ‚ùå CASCADE DELETE: registro de patients no se elimin√≥'
    END AS cascade_test_patient
FROM patients WHERE user_id = @test_patient_id;

-- Eliminar usuario admin
DELETE FROM users WHERE id = @test_admin_id;

SELECT
    CASE
        WHEN COUNT(*) = 0 THEN '  ‚úì CASCADE DELETE: admins eliminado autom√°ticamente'
        ELSE '  ‚ùå CASCADE DELETE: registro de admins no se elimin√≥'
    END AS cascade_test_admin
FROM admins WHERE user_id = @test_admin_id;

-- ============================================================================
-- 6. ESTAD√çSTICAS FINALES
-- ============================================================================

SELECT '' AS '';
SELECT 'üìä PASO 6: Estad√≠sticas finales...' AS status;

SELECT CONCAT('  ‚Ä¢ Total users: ', COUNT(*)) AS count FROM users;
SELECT CONCAT('  ‚Ä¢ Total doctors: ', COUNT(*)) AS count FROM doctors;
SELECT CONCAT('  ‚Ä¢ Total patients: ', COUNT(*)) AS count FROM patients;
SELECT CONCAT('  ‚Ä¢ Total admins: ', COUNT(*)) AS count FROM admins;

-- Verificar que no hay registros hu√©rfanos
SELECT
    CASE
        WHEN COUNT(*) = 0 THEN '  ‚úì Sin registros hu√©rfanos en doctors'
        ELSE CONCAT('  ‚ö†Ô∏è  ', COUNT(*), ' doctors sin user_id v√°lido')
    END AS orphan_check_doctors
FROM doctors d
LEFT JOIN users u ON d.user_id = u.id
WHERE u.id IS NULL;

SELECT
    CASE
        WHEN COUNT(*) = 0 THEN '  ‚úì Sin registros hu√©rfanos en patients'
        ELSE CONCAT('  ‚ö†Ô∏è  ', COUNT(*), ' patients sin user_id v√°lido')
    END AS orphan_check_patients
FROM patients p
LEFT JOIN users u ON p.user_id = u.id
WHERE u.id IS NULL;

SELECT
    CASE
        WHEN COUNT(*) = 0 THEN '  ‚úì Sin registros hu√©rfanos en admins'
        ELSE CONCAT('  ‚ö†Ô∏è  ', COUNT(*), ' admins sin user_id v√°lido')
    END AS orphan_check_admins
FROM admins a
LEFT JOIN users u ON a.user_id = u.id
WHERE u.id IS NULL;

-- ============================================================================
-- TESTING COMPLETADO
-- ============================================================================

SELECT '' AS '';
SELECT '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó' AS '';
SELECT '‚ïë                 ‚úì TESTING COMPLETADO                          ‚ïë' AS '';
SELECT '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù' AS '';
SELECT '' AS '';
SELECT '‚úÖ Verificaciones realizadas:' AS '';
SELECT '   1. Estructura de tablas' AS '';
SELECT '   2. Creaci√≥n de usuarios de prueba' AS '';
SELECT '   3. Integridad referencial' AS '';
SELECT '   4. Campos espec√≠ficos' AS '';
SELECT '   5. CASCADE DELETE' AS '';
SELECT '   6. Registros hu√©rfanos' AS '';
SELECT '' AS '';
SELECT 'üéØ Siguiente paso: Probar desde manage-users.php' AS '';
SELECT '   1. Abrir http://localhost/hospital/hms/admin/manage-users.php' AS '';
SELECT '   2. Crear un nuevo usuario (doctor/patient/admin)' AS '';
SELECT '   3. Verificar que se crea el registro en la tabla correspondiente' AS '';
SELECT '' AS '';
SELECT '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó' AS '';

-- ============================================================================
-- QUERIES √öTILES PARA DEBUGGING
-- ============================================================================

/*
-- Ver todos los doctors con sus usuarios
SELECT
    u.id, u.full_name, u.email, u.user_type,
    d.license_number, d.consultation_fee, d.specialization_id
FROM users u
LEFT JOIN doctors d ON u.id = d.user_id
WHERE u.user_type = 'doctor';

-- Ver todos los patients con sus usuarios
SELECT
    u.id, u.full_name, u.email, u.user_type,
    p.address, p.city, p.blood_type, p.gender
FROM users u
LEFT JOIN patients p ON u.id = p.user_id
WHERE u.user_type = 'patient';

-- Ver todos los admins con sus usuarios
SELECT
    u.id, u.full_name, u.email, u.user_type,
    a.employee_id, a.department, a.admin_level, a.certifications
FROM users u
LEFT JOIN admins a ON u.id = a.user_id
WHERE u.user_type = 'admin';
*/
